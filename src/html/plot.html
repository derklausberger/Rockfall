{% extends 'base.html' %}

{% block title %}
    Chart
{% endblock %}


{% block content %}
   <ul class="nav nav-tabs" id="pilot-case-nav" role="tablist"></ul>
   <div class="tab-content" id="charts-tab-content">
   </div>
   <table id="ftc-table">
      <thead>
         <tr>
            <th>Stage</th>
            <th>Begin</th>
            <th>End</th>
            <th>Duration</th>
         </tr>
      </thead>
      <tbody id="ftc-tbody">
         <tr>
            <td>Stage</td>
         </tr>

         <tr>
            <td>Stage</td>
         </tr>

         <tr>
            <td>Stage</td>
         </tr>

         <tr>
            <td>Stage</td>
         </tr>
      </tbody>
   </table>

{% endblock %}

{% block scripts %}
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
   
   <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

   <script>
      var pilotCaseNav = document.getElementById("pilot-case-nav")
      var chartsDiv = document.getElementById("charts-tab-content")

      var dynamicColors = function() {
            var r = Math.floor(Math.random() * 255);
            var g = Math.floor(Math.random() * 255);
            var b = Math.floor(Math.random() * 255);
            return "rgb(" + r + "," + g + "," + b + ")";
      }
      
      {% for pc, pc_data in data.items() %}
         // pilot case data
         pc = "{{ pc }}"

         //append the tab for the pilot case
         var li = document.createElement("li")
         li.className = "nav-item"
         li.role = "presentation"

         var btn = document.createElement("button")
         btn.className = "nav-link"
         btn.textContent = pc
         btn.id = pc + "-tab"
         btn.setAttribute("data-bs-toggle", "tab")
         btn.setAttribute("data-bs-target", "#" + pc)
         btn.setAttribute("type", "button")
         btn.setAttribute("role", "tab")
         btn.setAttribute("aria-controls", pc)
         btn.setAttribute("aria-selected", false)

         li.append(btn)
         pilotCaseNav.append(li)

         //append the chart for the pilot case
         var chartDiv = document.createElement("div")
         chartDiv.classList.add("tab-pane", "fade")
         chartDiv.id = pc
         chartDiv.role = "tabpanel"
         chartDiv.setAttribute("aria-labelledby", pc + "-tab")

         var chartCanvas = document.createElement("canvas")
         chartCanvas.id = pc + "-chart"
         chartDiv.style.width = ""

         chartDiv.append(chartCanvas)
         chartsDiv.append(chartDiv)

         lines = []

         {% for label, data in pc_data.items() if (label != "dt" and label != "ftc") %}
            if (containsNotNoneValues("{{ data[0] }}")) {
               lines.push({
                  label: "{{ label }}",
                     data: [
                        {% for item in data[0] %}
                           {{ item if item is not none }},
                        {% endfor %}
                     ],
                     backgroundColor: dynamicColors(),
                     borderColor: dynamicColors(),
                     borderWidth: 1,
                     spanGaps: true,
                     yAxisID: "{{data[1]}}"
               })
            }
         {% endfor %}
         
         var backgroundColorRange = {
            id: "backgroundColorRange",   
            beforeDatasetDraw(chart, args, pluginOptios) {
               if (containsNotNoneValues("{{ pc_data['ftc'] }}")) {
                  const { ctx, data, chartArea: {top, bottom, left, right, width, height},
                     scales: {x, y} } = chart;

                  ctx.save();
                  
                  {% for item in pc_data['ftc'] %}
                     var cb_date = new Date("{{ item['cb'] }}")
                     var fb_date = new Date("{{ item['fb'] }}")
                     var wb_date = new Date("{{ item['wb'] }}")
                     var tb_date = new Date("{{ item['tb'] }}")

                     var cb_x = x.getPixelForValue(cb_date.getTime())
                     var fb_x = x.getPixelForValue(fb_date.getTime())
                     var wb_x = x.getPixelForValue(wb_date.getTime())
                     var tb_x = x.getPixelForValue(tb_date.getTime())


                     var fb_dist = fb_x - cb_x
                     var wb_dist = wb_x - fb_x
                     var tb_dist = tb_x - wb_x

                     
                     ctx.fillStyle = 'rgba(116, 85, 155, 0.4)';
                     ctx.fillRect(cb_x, top, fb_dist, height);

                     ctx.fillStyle = 'rgba(112, 184, 74, 0.4)';
                     ctx.fillRect(fb_x, top, wb_dist, height);

                     ctx.fillStyle = 'rgba(214, 107, 63, 0.4)';
                     ctx.fillRect(wb_x, top, tb_dist, height);

                     ctx.restore();

                     addEvent(chartCanvas, 'click', function (event) {
                        var rect = event.target.getBoundingClientRect();
                        var clickX = event.clientX - rect.left;

                        if (clickX > cb_x && clickX < tb_x) {
                           console.log("hier")
                           var new_body = document.createElement("tbody")

                           new_body.append(
                              createFTCRow("Cooling", cb_date, fb_date, fb_date - cb_date),
                              createFTCRow("Freezing", fb_date, wb_date, wb_date - fb_date),
                              createFTCRow("Thawing", wb_date, tb_date, tb_date - wb_date),
                              createFTCRow("Warming", wb_date, null, null)
                           )

                           var ftc_table = document.getElementById("ftc-table")
                           var old_body = document.getElementById("ftc-tbody")


                           old_body.replaceWith(new_body)
                        }
                     })
                  {% endfor %}                  
               }
            }
         }

         var ctx = chartCanvas.getContext("2d")
         var config = {
            type: 'line',
            data: {
               labels: [
                  {% for item in pc_data['dt'] %}
                     "{{ item }}",
                  {% endfor %}
               ],
               datasets: lines,
            },
            options: {
               plugins: {
                  title: {
                     text: "{{pc}}",
                     display: false
                  },
                  legend: {
                     position: "right",
                     align: "middle"
                  }
               },
               scales: {
                  x: {
                     type: 'time',
                     time: {
                        tooltipFormat: 'dd.MM.yy HH:mm',
                        displayFormats: {
                           day: 'dd.MM yy',
                           minute: 'dd.MMM yy HH:mm',
                           hour: 'dd.MMM yy hha'
                        }
                     },
                     title: {
                        display: true,
                        text: 'Date'
                     }
                  },
                  degr: {
                     position: 'left',
                     title: {
                        display: true,
                        text: 'Â°C'
                     }
                  },
                  mm: {
                     position: 'left',
                     title: {
                        display: true,
                        text: 'mm'
                     }
                  },
                  perc: {
                     position: 'left',
                     title: {
                        display: true,
                        text: '%'
                     }
                  },
               },
               elements: {
                  point: {
                     radius: 0 // default to disabled in all datasets
                  }
               }
            },
            plugins: [backgroundColorRange]
         }

         var chart = new Chart(ctx, config)
      {% endfor %}

      var active_tab = pilotCaseNav.firstChild.firstChild
      active_tab.classList.add("active")
      active_tab.setAttribute("aria-selected", true)

      var active_div = document.getElementById(active_tab.id.slice(0, -4))
      active_div.classList.add("show", "active")

      function containsNotNoneValues(string){
         return string.replace(/None|,|\[|\]|\s/g,'').length > 0
      }

      function addEvent(obj, evType, fn) {
         if (obj.addEventListener) {
            obj.addEventListener(evType, fn, false);
            return true;
         } else if (obj.attachEvent) {
            var r = obj.attachEvent("on" + evType, fn);
            return r;
         } else {
            alert("Handler could not be attached");
         }
      }

      function createFTCRow(stage, begin, end, diff) {
         var td1 = document.createElement("td")
         td1.innerHTML = stage

         var td2 = document.createElement("td")
         if (begin)
            td2.innerHTML = begin.toLocaleString()

         var td3 = document.createElement("td")
         if (end)
            td3.innerHTML = end.toLocaleString()

         var td4 = document.createElement("td")

         var daysDifference = Math.floor(diff/1000/60/60/24);
         diff -= daysDifference*1000*60*60*24

         var hoursDifference = Math.floor(diff/1000/60/60);
         diff -= hoursDifference*1000*60*60

         var minutesDifference = Math.floor(diff/1000/60);
         diff -= minutesDifference*1000*60

         td4.innerHTML = daysDifference + 'd ' +
            hoursDifference + 'H ' + 
            minutesDifference + 'm ';
         
         var tr = document.createElement("tr")
         tr.append(td1, td2, td3, td4)

         return tr
      }
    </script>

{% endblock %}